# --- Builder stage: compile pgpool-II ---
ARG TARGETARCH="aarch64"
FROM rockylinux:9.3 AS builder

RUN dnf -y update \
    && dnf install -y epel-release \
    && dnf config-manager --set-enabled crb \
    && rpm --import https://download.postgresql.org/pub/repos/yum/keys/RPM-GPG-KEY-PGDG \
    && dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-aarch64/pgdg-redhat-repo-latest.noarch.rpm \
    && dnf install -y --setopt=install_weak_deps=False \
       gcc make wget \
       postgresql17-devel \
       libmemcached libmemcached-devel \
       redhat-rpm-config annobin \
    && dnf clean all && rm -rf /var/cache/dnf /tmp/*

WORKDIR /tmp/pgpool
RUN wget https://www.pgpool.net/mediawiki/images/pgpool-II-4.5.4.tar.gz \
    && tar -xzf pgpool-II-4.5.4.tar.gz --strip-components=1 \
    && ./configure --prefix=/usr/local/pgpool --with-pgsql=/usr/pgsql-17/ --sysconfdir=/etc/pgpool-II \
    && make && make install \
    && rm -rf /tmp/pgpool*

# --- Final stage: runtime image ---
FROM rockylinux:9.3

ARG MYTOKEN=""

# Install required repos and runtime packages only
RUN curl -1sSLf "https://downloads.enterprisedb.com/${MYTOKEN}/enterprise/setup.rpm.sh" | bash \
    && dnf install -y --setopt=install_weak_deps=False \
       edb-postgresextended17-server \
       edb-postgresextended17-contrib \
       edb-efm50 \
       epel-release \
    && dnf config-manager --set-enabled crb \
    && rpm --import https://download.postgresql.org/pub/repos/yum/keys/RPM-GPG-KEY-PGDG \
    && dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-aarch64/pgdg-redhat-repo-latest.noarch.rpm \
    && dnf install -y --setopt=install_weak_deps=False \
       openssh-server openssh-clients \
       procps-ng iproute iputils less diffutils watchdog \
       pgbackrest pgbouncer patroni-etcd pg_repack_17 pg_top repmgr_17 haproxy \
       pgpool-II-pg17-extensions \
    && dnf clean all \
    && rm -rf /var/cache/dnf /tmp/* /usr/share/doc /usr/share/man /usr/share/info

# Copy pgpool binaries and configs from builder
COPY --from=builder /usr/local/pgpool/bin /usr/local/pgpool/bin
COPY --from=builder /etc/pgpool-II /etc/pgpool-II

# Create directories and set ownership
RUN mkdir -p /pgdata/17/ /etc/pgpool-II /var/log/{etcd,patroni} /pgha/{config,certs,data/{etcd,postgres,pgbackrest}} \
    && chown -R postgres:postgres /pgdata /etc/pgpool-II /var/log/{etcd,patroni} /pgha \
    && chmod 0700 /pgdata \
    && touch /etc/pgbackrest.conf && chown postgres:postgres /etc/pgbackrest.conf

# --- COPY Files ---
COPY pg_custom.conf /
COPY pg_hba.conf /
COPY pg_hba_md5.conf /
COPY pgsqlProfile /
COPY id_rsa /
COPY id_rsa.pub /
COPY authorized_keys /
COPY proxysql.cnf /
COPY recovery_1st_stage /
COPY follow_primary.sh /
COPY pgpool_remote_start /
COPY failover.sh /
COPY etcdSetup.sh /
COPY patroniSetup.sh /
COPY createRoles.sh /
COPY stopPatroni /
COPY startPatroni /

# --- Set Ownerships & Permissions ---
RUN chown postgres:postgres /recovery_1st_stage /follow_primary.sh /pgpool_remote_start /failover.sh \
    /etcdSetup.sh /patroniSetup.sh /createRoles.sh /stopPatroni /startPatroni \
    && chmod 755 /recovery_1st_stage /follow_primary.sh /pgpool_remote_start /failover.sh \
    /etcdSetup.sh /patroniSetup.sh /createRoles.sh /startPatroni /stopPatroni

# --- Expose Ports ---
EXPOSE 22 80 443 5432 2379 2380 6032 6033 6132 6133 8432 5000 5001 8008 9999 9898 7000

# --- Entrypoint ---
COPY entrypoint.sh /
RUN chmod +x /entrypoint.sh
SHELL ["/bin/bash", "-c"]
ENTRYPOINT ["/entrypoint.sh"]

