ARG TARGETARCH="aarch64"
FROM rockylinux:9.3 AS builder

RUN dnf -y update \
    && dnf install -y epel-release \
    && dnf config-manager --set-enabled crb \
    && rpm --import https://download.postgresql.org/pub/repos/yum/keys/RPM-GPG-KEY-PGDG \
    && dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-9-aarch64/pgdg-redhat-repo-latest.noarch.rpm \
    && dnf install -y --setopt=install_weak_deps=False \
       gcc make wget \
       postgresql17-devel \
       libmemcached libmemcached-devel \
       redhat-rpm-config annobin \
    && dnf clean all && rm -rf /var/cache/dnf /tmp/*


RUN dnf -y update && \
    dnf install -y wget telnet jq vim sudo gnupg openssh-server openssh-clients \
                   procps-ng net-tools iproute iputils less diffutils watchdog epel-release && \
    dnf clean all && rm -rf /var/cache/dnf

# Copy configuration files and scripts

COPY id_rsa / 
COPY id_rsa.pub / 
COPY authorized_keys / 

# Expose ports
EXPOSE 22 80 443 5432 2379 2380 6032 6033 6132 6133 8432 5000 5001 8008 9999 9898 7000 

# Entrypoint
COPY entrypoint.sh / 
RUN chmod +x /entrypoint.sh 
ENTRYPOINT ["/entrypoint.sh"]
